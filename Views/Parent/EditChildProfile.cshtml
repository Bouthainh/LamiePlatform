@model BadeePlatform.DTOs.EditChildDTO

@{
    ViewData["Title"] = "لامع - تعديل معلومات الطفل";
    var childId = ViewBag.ChildId as string;
}
@{
    ViewData["HideHeader"] = true;
    ViewData["HideFooter"] = true;
    ViewData["SpicalHeader"] = true;
    ViewData["SpicalFooter"] = true;
}
<link rel="icon" type="image/png" href="~/images/LamieLogo.png" />

<main class="edit-child-page">
    <div class="main-container">
        <section class="main-content">
            <div class="form-container">
                <div class="form-header">
                    <h1>تعديل معلومات الطفل</h1>
                </div>

                @if (TempData["EditChildError"] != null)
                {
                    <div class="alert alert-danger">@TempData["EditChildError"]</div>
                }

                <form asp-action="EditChildProfile" asp-controller="Parent"
                      asp-route-childId="@childId" method="post" id="editChildForm">
                    @Html.AntiForgeryToken()

                    <div class="form-section">
                        <h2>بيانات الطفل</h2>

                        <div class="form-group">
                            <label asp-for="FirstName">الاسم الأول</label>
                            <input asp-for="FirstName" type="text" class="form-control" required placeholder="أدخل الاسم الأول" />
                            <span asp-validation-for="FirstName" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="FatherName">اسم الأب</label>
                            <input asp-for="FatherName" type="text" class="form-control" required placeholder="أدخل اسم الأب" />
                            <span asp-validation-for="FatherName" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="GrandFatherName">اسم الجد</label>
                            <input asp-for="GrandFatherName" type="text" class="form-control" required placeholder="أدخل اسم الجد" />
                            <span asp-validation-for="GrandFatherName" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="LastName">اسم العائلة</label>
                            <input asp-for="LastName" type="text" class="form-control" required placeholder="أدخل اسم العائلة" />
                            <span asp-validation-for="LastName" class="text-danger"></span>
                        </div>


                        <div class="form-row">
                            <div class="form-group">
                                <label asp-for="Age">العمر</label>
                                <select asp-for="Age" class="form-control">
                                    <option value="">اختر العمر</option>
                                    <option value="4">4 سنوات</option>
                                    <option value="5">5 سنوات</option>
                                    <option value="6">6 سنوات</option>
                                    <option value="7">7 سنوات</option>
                                    <option value="8">8 سنوات</option>
                                </select>
                                <span asp-validation-for="Age" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="Gender">الجنس</label>
                                <select asp-for="Gender" class="form-control">
                                    <option value="">اختر الجنس</option>
                                    <option value="ذكر">ذكر</option>
                                    <option value="أنثى">أنثى</option>
                                </select>
                                <span asp-validation-for="Gender" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2>بيانات المدرسة</h2>

                        <div class="form-group">
                            <label asp-for="City">المدينة</label>
                            <select asp-for="City" id="cityDropdown" class="form-control">
                                <option value="">اختر المدينة</option>
                                @if (ViewBag.Cities != null)
                                {
                                    @foreach (var city in ViewBag.Cities)
                                    {
                                        <option value="@city">@city</option>
                                    }
                                }
                            </select>
                            <span asp-validation-for="City" class="text-danger"></span>
                        </div>

                        <div class="form-group">
                            <label asp-for="SchoolId">اسم المدرسة</label>
                            <select asp-for="SchoolId" id="schoolDropdown" class="form-control">
                                <option value="">اختر المدرسة</option>
                            </select>
                            <span asp-validation-for="SchoolId" class="text-danger"></span>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label asp-for="GradeId">المرحلة الدراسية</label>
                                <select asp-for="GradeId" id="gradeDropdown" class="form-control">
                                    <option value="">اختر المرحلة</option>
                                </select>
                                <span asp-validation-for="GradeId" class="text-danger"></span>
                            </div>

                            <div class="form-group">
                                <label asp-for="ClassId">الفصل</label>
                                <select asp-for="ClassId" id="classDropdown" class="form-control">
                                    <option value="">اختر الفصل</option>
                                </select>
                                <span asp-validation-for="ClassId" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="submit-btn">حفظ التعديلات</button>
                        <a asp-action="ViewChildProfile" asp-route-childId="@childId"
                           class="cancel-btn">إلغاء</a>
                    </div>
                </form>
            </div>
        </section>
    </div>
</main>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            const originalCity = '@Html.Raw(Model.City)';
            const originalSchoolId = '@Html.Raw(Model.SchoolId)';
            const originalGradeId = '@Html.Raw(Model.GradeId)';
            const originalClassId = '@Html.Raw(Model.ClassId)';

            let isInitialLoad = true;

            $('#cityDropdown').change(function () {
                var city = $(this).val();
                var $schoolDropdown = $('#schoolDropdown');
                var $gradeDropdown = $('#gradeDropdown');
                var $classDropdown = $('#classDropdown');

                $schoolDropdown.html('<option value="">اختر المدرسة</option>');
                $gradeDropdown.html('<option value="">اختر المرحلة</option>');
                $classDropdown.html('<option value="">اختر الفصل</option>');

                if (city) {
                    $.ajax({
                        url: '@Url.Action("GetSchoolsByCity", "Parent")',
                        type: 'GET',
                        data: { city: city },
                        success: function (schools) {
                            $.each(schools, function (i, school) {
                                $schoolDropdown.append(
                                    $('<option>', { value: school.id, text: school.name })
                                );
                            });

                            if (isInitialLoad && originalSchoolId) {
                                setTimeout(function() {
                                    $schoolDropdown.val(originalSchoolId);
                                    $schoolDropdown.trigger('change');
                                }, 100);
                            }
                        }
                    });
                }
            });

            $('#schoolDropdown').change(function () {
                var schoolId = $(this).val();
                var $gradeDropdown = $('#gradeDropdown');
                var $classDropdown = $('#classDropdown');

                $gradeDropdown.html('<option value="">اختر المرحلة</option>');
                $classDropdown.html('<option value="">اختر الفصل</option>');

                if (schoolId) {
                    $.ajax({
                        url: '@Url.Action("GetGradesBySchool", "Parent")',
                        type: 'GET',
                        data: { schoolId: schoolId },
                        success: function (grades) {
                            $.each(grades, function (i, grade) {
                                $gradeDropdown.append(
                                    $('<option>', { value: grade.id, text: grade.name })
                                );
                            });

                            if (isInitialLoad && originalGradeId) {
                                setTimeout(function() {
                                    $gradeDropdown.val(originalGradeId);
                                    $gradeDropdown.trigger('change');
                                }, 100);
                            }
                        }
                    });
                }
            });

            $('#gradeDropdown').change(function () {
                var gradeId = $(this).val();
                var $classDropdown = $('#classDropdown');

                $classDropdown.html('<option value="">اختر الفصل</option>');

                if (gradeId) {
                    $.ajax({
                        url: '@Url.Action("GetClassesByGrade", "Parent")',
                        type: 'GET',
                        data: { gradeId: gradeId },
                        success: function (classes) {
                            $.each(classes, function (i, cls) {
                                var displayText = cls.name;
                                if (cls.educator)
                                    displayText += ' - المعلم/ة: ' + cls.educator;

                                $classDropdown.append(
                                    $('<option>', { value: cls.id, text: displayText })
                                );
                            });

                            if (isInitialLoad && originalClassId) {
                                setTimeout(function() {
                                    $classDropdown.val(originalClassId);
                                    isInitialLoad = false;
                                }, 100);
                            }
                        }
                    });
                }
            });

            if (originalCity && originalCity !== '') {
                setTimeout(function() {
                    $('#cityDropdown').val(originalCity);
                    $('#cityDropdown').trigger('change');
                }, 200);
            }
        });
    </script>
}